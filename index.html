// Função para verificar e configurar o MediaRecorder corretamente
async function initAudioRecorder() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                channelCount: 1,
                sampleRate: 44100,
                echoCancellation: true,
                noiseSuppression: true
            } 
        });
        
        // Configurações compatíveis para diferentes navegadores
        let options = {};
        const mimeTypes = [
            'audio/webm;codecs=opus',
            'audio/webm',
            'audio/mp4',
            'audio/mp4;codecs=mp4a',
            'audio/mpeg'
        ];
        
        for (let mimeType of mimeTypes) {
            if (MediaRecorder.isTypeSupported(mimeType)) {
                options = { mimeType: mimeType };
                console.log("Usando MIME type:", mimeType);
                break;
            }
        }
        
        // Se nenhum tipo específico for suportado, usar o padrão
        audioRecorder = new MediaRecorder(stream, options);
        
        audioRecorder.ondataavailable = (event) => {
            if (event.data && event.data.size > 0) {
                audioChunks.push(event.data);
                console.log("Dados de áudio recebidos:", event.data.size, "bytes");
            }
        };
        
        audioRecorder.onstop = async () => {
            try {
                console.log("Parando gravação, chunks:", audioChunks.length);
                
                if (audioChunks.length === 0) {
                    throw new Error("Nenhum dado de áudio foi capturado");
                }
                
                // Criar Blob para preview
                const audioBlob = new Blob(audioChunks, { 
                    type: audioRecorder.mimeType || 'audio/webm' 
                });
                
                console.log("Blob criado para preview:", audioBlob.size, "bytes");
                
                if (audioBlob.size === 0) {
                    throw new Error("Blob de áudio está vazio");
                }
                
                currentRecording = URL.createObjectURL(audioBlob);
                
                document.getElementById('audioControls').style.display = 'block';
                const audioElement = document.getElementById('audioPlayback');
                audioElement.src = currentRecording;
                
                audioElement.onerror = function() {
                    console.error("Erro ao carregar áudio para preview");
                    showStatus('Erro ao carregar prévia do áudio. O áudio ainda será salvo.', 'error');
                };
                
                audioElement.load();
                
                document.getElementById('recordBtn').innerHTML = '<i class="fas fa-microphone"></i><span>Gravar Novamente</span>';
                
                showStatus('Gravação concluída! Clique no mapa para escolher a localização.', 'success');
                setTimeout(() => {
                    document.getElementById('statusMessage').style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error("Erro ao processar gravação:", error);
                showStatus('Erro ao processar a gravação: ' + error.message, 'error');
                resetRecordingState();
            }
        };
        
        audioRecorder.onerror = (event) => {
            console.error("Erro no MediaRecorder:", event);
            showStatus('Erro durante a gravação. Tente novamente.', 'error');
            resetRecordingState();
        };
        
    } catch (error) {
        console.error("Erro ao acessar microfone: ", error);
        handleMicrophoneError(error);
    }
}

// Função para tratar erros do microfone
function handleMicrophoneError(error) {
    let errorMessage = "Não foi possível acessar o microfone. ";
    
    if (error.name === 'NotAllowedError') {
        errorMessage += "Permissão negada. Por favor, permita o acesso ao microfone nas configurações do seu navegador.";
    } else if (error.name === 'NotFoundError') {
        errorMessage += "Nenhum microfone encontrado. Verifique se seu dispositivo tem um microfone disponível.";
    } else if (error.name === 'NotSupportedError') {
        errorMessage += "Gravação de áudio não é suportada neste navegador. Tente usar Chrome, Firefox ou Safari atualizado.";
    } else {
        errorMessage += "Erro: " + error.message;
    }
    
    showStatus(errorMessage, 'error');
}
